<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Игра Память на квадрате</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 20px;
    background: #f0f0f0;
  }
  #game {
    display: grid;
    justify-content: center;
    margin-top: 20px;
  }
  .square {
    background-color: #666;
    border-radius: 6px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  .red {
    background-color: red !important;
  }
  .covered {
    background-color: #222 !important;
    cursor: pointer;
  }
  #startBtn, #stopBtn, #result {
    margin-top: 20px;
    font-size: 18px;
  }
  #result {
    font-weight: bold;
    min-height: 24px;
  }
</style>
</head>
<body>

<h2>Игра на память: Найдите красные квадраты</h2>
<button id="startBtn">Начать игру</button>
<button id="stopBtn" disabled>Закончить игру</button>
<div id="game"></div>
<div id="result"></div>

<script>
  const game = document.getElementById('game');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const result = document.getElementById('result');

  let size = 6;
  let squareSize = 40; // размер квадрата в px
  let gapSize = 6;     // отступ между квадратами

  let redIndexes = [];
  let state = 'idle'; // idle, showRed, covered, selecting
  let timerId = null;

  let correctCount = 0;
  let totalGames = 0;
  let squaresToFind = 1;

  function updateGridStyle() {
    game.style.gridTemplateColumns = `repeat(${size}, ${squareSize}px)`;
    game.style.gridTemplateRows = `repeat(${size}, ${squareSize}px)`;
    game.style.gap = gapSize + 'px';
  }

  function createBoard() {
    game.innerHTML = '';
    updateGridStyle();
    for (let i = 0; i < size * size; i++) {
      const sq = document.createElement('div');
      sq.classList.add('square');
      sq.style.width = squareSize + 'px';
      sq.style.height = squareSize + 'px';
      sq.dataset.index = i;
      sq.addEventListener('click', onSquareClick);
      game.appendChild(sq);
    }
  }

  // Выбираем уникальные индексы красных квадратов
  function pickRedIndexes() {
    const count = squaresToFind;
    const totalSquares = size * size;
    const picked = new Set();
    while (picked.size < count) {
      picked.add(Math.floor(Math.random() * totalSquares));
    }
    return Array.from(picked);
  }

  function showRed() {
    state = 'showRed';
    const squares = document.querySelectorAll('.square');
    redIndexes = pickRedIndexes();
    squares.forEach((sq, i) => {
      sq.classList.remove('red', 'covered');
      sq.style.pointerEvents = 'none';
      sq.style.backgroundColor = '';
      if (redIndexes.includes(i)) {
        sq.classList.add('red');
      }
    });

    setTimeout(() => {
      coverAll();
    }, 1500 + 700 * (squaresToFind - 1)); // больше времени для большего количества
  }

  function coverAll() {
    state = 'covered';
    const squares = document.querySelectorAll('.square');
    squares.forEach(sq => {
      sq.classList.remove('red');
      sq.classList.add('covered');
      sq.style.pointerEvents = 'auto';
      sq.style.backgroundColor = '';
    });
    result.textContent = `Найдите ${squaresToFind} красный${squaresToFind === 1 ? 'й' : 'х'} квадрат${squaresToFind === 1 ? '' : 'ов'}, кликнув по ним по очереди.`;
    state = 'selecting';
  }

  let userGuesses =[];

  function onSquareClick(e) {
    if (state !== 'selecting') return;
    const clickedIndex = +e.target.dataset.index;
    const squares = document.querySelectorAll('.square');

    if(userGuesses.includes(clickedIndex)){
      // не учитываем клики по уже выбранным
      return;
    }

    userGuesses.push(clickedIndex);

    if (redIndexes.includes(clickedIndex)) {
      // Правильный выбор — подсвечиваем красным
      squares[clickedIndex].classList.remove('covered');
      squares[clickedIndex].classList.add('red');
    } else {
      // Неправильный — подсвечиваем красным ошибку и показываем все верные
      squares[clickedIndex].style.backgroundColor = '#880000';
      redIndexes.forEach(idx => {
        squares[idx].classList.remove('covered');
        squares[idx].classList.add('red');
      });
      state = 'idle';
      totalGames++;
      result.textContent = 'Неправильно. Вот где были красные квадраты.';
      userGuesses = [];
      timerId = setTimeout(() => {
        if (state === 'idle') {
          startGame();
        }
      }, 2000);
      return;
    }

    // Если пользователь угадал все нужные квадраты
    if(userGuesses.length === squaresToFind){
      totalGames++;
      correctCount++;
      state = 'idle';
      result.textContent = `Отлично! Вы нашли все ${squaresToFind} правильных квадрата.`;

      // Логика усложнения

      if (size < 10) {
        if (correctCount > 0 && correctCount % 2 === 0) {
          size = Math.min(size + 1, 10);
          squareSize = Math.max(squareSize - 3, 20);
          gapSize = Math.max(gapSize - 1, 2);
        }
      } else {
        // Если сетка 12x12, увеличиваем количество квадратов для поиска после каждых 2 правильных ответов
        if (correctCount > 0 && correctCount % 2 === 0) {
          squaresToFind++;
        }
      }

      userGuesses = [];
      timerId = setTimeout(() => {
        if (state === 'idle') {
          startGame();
        }
      }, 2000);
    }
  }

  function startGame() {
    startBtn.disabled = true;
    stopBtn.disabled = false;
    result.textContent = '';
    createBoard();
    showRed();
  }

  function stopGame() {
    if(timerId){
      clearTimeout(timerId);
      timerId = null;
    }
    state = 'idle';
    startBtn.disabled = false;
    stopBtn.disabled = true;

    game.innerHTML = '';
    result.innerHTML = 
      `Игра окончена.<br>
      Всего попыток: <b>${totalGames}</b><br>
      Правильных ответов: <b>${correctCount}</b><br>
      Текущий размер сетки: <b>${size}x${size}</b><br>
      Количество квадратов для поиска: <b>${squaresToFind}</b>`;

    // Сброс параметров
    size = 6;
    squareSize = 40;
    gapSize = 6;
    correctCount = 0;
    totalGames = 0;
    squaresToFind = 1;
    userGuesses = [];
  }

  startBtn.addEventListener('click', () => {
    if (timerId) {
      clearTimeout(timerId);
      timerId = null;
    }
    startGame();
  });

  stopBtn.addEventListener('click', stopGame);

  createBoard();
</script>

</body>
</html>